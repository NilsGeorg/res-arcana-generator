<!DOCTYPE html>
<html lang="en">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"
            integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
            integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
            crossorigin="anonymous"></script>

    <title>Res Arcana Generator</title>
    <meta charset="UTF-8">

    <style>
        .game-card {
            margin: 0.5rem;
            padding: 0.5rem;
            border-radius: 5%;
        }

        .game-card-front {
            background-color: #ffa500;
        }

        .game-card-back {
            background-color: #3737ff;
        }


        .list-group-item.active {
            background-color: #5c636a;
            border-color: #565e64;
        }

        .list-group {
            display: inline-block;
        }
    </style>
</head>

<body>
<header class="p-3 bg-dark text-white">
    <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-center">
            <b>Res Arcana Generator</b>
        </div>
    </div>
</header>

<main class="container mt-3">
    <div class="loading mx-auto" id="spinner">
        <div class="spinner-border" role="status"></div>
    </div>

    <div id="set-list-container">
        <div class="row mt-3">
            <div class="col d-flex justify-content-center">
                <div class="list-group" id="set-list"></div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col d-flex justify-content-center">
                <select name="selectAmountPlayers" id="selectAmountPlayers">
                    <option value="2" selected>2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col d-flex justify-content-center">
                <div class="form-check">
                    <input type="checkbox" name="baseGameScaling" id="baseGameScaling" class="form-check-input">
                    <label for="baseGameScaling" class="form-check-label">Base Game Scaling</label>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col d-flex justify-content-center">
                <button type="button" id="btn-generate" class="btn btn-secondary px-4 me-sm-3" onclick="generate()">
                    Generate
                </button>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col">
                <div class="d-flex flex-wrap justify-content-center" id="generated-set">

                </div>
            </div>
        </div>
    </div>


    </div>
</main>
<script>
    "use strict";

    let sets = [
        {
            name: "Base Game",
            cards: [
                {a: "Sacred Grove", b: "Alchemist's Tower"},
                {a: "Catacombs of the Dead", b: "Sacrificial Pit"},
                {a: "Cursed Forge", b: "Dwarven Mines"},
                {a: "Coral Castle", b: "Sunken Reef"},
                {a: "Dragon's Lair", b: "Sorcerer's Bestiary"},
            ],
            isActive: true,
        },
        {
            name: "Luxt",
            cards: [
                {a: "Dragon Aerie", b: "Crystal Keep"},
                {a: "Temple of the Abyss", b: "Gate of Hell"},
            ],
            isActive: false,
        },
        {
            name: "Perlae Imperii",
            cards: [
                {a: "Mystical Menagerie", b: "Alchemical Workshop"},
                {a: "Blood Isle", b: "Pearl Bed"},
            ],
            isActive: false,
        }
    ]

    let setList = document.getElementById("set-list")


    init()

    function init() {
        let setListContainer = document.getElementById("set-list-container")
        let spinner = document.getElementById("spinner")

        for (let i = 0; i < sets.length; i++) {
            let setListNode = createSetListNode(sets[i])
            setList.appendChild(setListNode)
        }

        setListContainer.classList.remove("d-none")
        spinner.classList.add("d-none")
    }

    function generate() {
        let generatedSetNode = document.getElementById("generated-set")
        generatedSetNode.innerHTML = ""

        let activeCards = getActiveCards()
        let baseGameScaling = getBaseGameScaling()
        let amountPlayers = getAmountPlayers()
        let amountCards = getAmountCards(amountPlayers, baseGameScaling)
        if (amountCards > activeCards.length) {
            amountCards = activeCards.length
        }

        let cards = getRandomCards(activeCards, amountCards)

        let choosenCardSides = cards.map(card => getCardSide(card))
        let cardNodes = choosenCardSides.map(cardSide => generateCardNode(cardSide))


        cardNodes.forEach(node => generatedSetNode.appendChild(node))
    }

    function generateCardNode(cardSide) {
        let nodeDiv = document.createElement("div")
        nodeDiv.classList.add("p-2")

        let nodeSpan = document.createElement("span")
        nodeSpan.innerHTML = cardSide.text
        nodeSpan.classList.add("game-card", "game-card-" + cardSide.side, "text-light")

        nodeDiv.appendChild(nodeSpan)

        return nodeDiv
    }

    function getCardSide(card) {
        let sides = [
            {side: "front", text: card.a},
            {side: "back", text: card.b}
        ]

        return sides[Math.floor(Math.random() * 2)]
    }

    function getRandomCards(cards, amount) {
        if (cards.length === amount) {
            return cards
        }

        let shadowCopyCards = cards.slice(0)

        let randomCards = []
        while (randomCards.length < amount) {
            let randomIndex = Math.floor(Math.random() * shadowCopyCards.length)
            randomCards.push(shadowCopyCards[randomIndex])
            shadowCopyCards.splice(randomIndex, 1)
        }

        return randomCards
    }

    function getBaseGameScaling() {
        return document.querySelector('#baseGameScaling').checked
    }

    function getAmountCards(amountPlayers, baseGameScaling) {
        let amountCards
        if (baseGameScaling) {
            amountCards = 5
        } else {
            amountCards = amountPlayers + 2
        }

        return amountCards
    }

    function getAmountPlayers() {
        let amountPlayers = document.getElementById("selectAmountPlayers")

        return Number(amountPlayers.value)
    }

    function getAmountMonuments(playerCount) {
        let monuments = 7
        if (playerCount > 2) {
            monuments = (playerCount * 2 + 4);
        }

        return monuments
    }

    function getActiveCards() {
        let activeCards = []
        for (var i = 0; i < setList.childNodes.length; i++) {
            let child = setList.childNodes[i]
            if (!child.classList.contains("active")) {
                continue
            }

            let array = JSON.parse(child.dataset.cards)
            array.forEach(it => activeCards.push(it))
        }

        return activeCards
    }


    function createSetListNode(setObject) {
        let button = document.createElement("button")

        button.id = "btn-set-" + setObject.name.toLowerCase().replaceAll(" ", "-")
        button.name = setObject.name
        button.type = "button"
        button.classList.add("list-group-item", "list-group-item-action", "text-center")

        let activeClass = "active"
        if (setObject.isActive) {
            button.classList.add(activeClass)
        }

        button.innerText = setObject.name
        button.addEventListener("click", () => button.classList.toggle(activeClass))
        button.dataset.cards = JSON.stringify(setObject.cards)

        return button
    }
</script>

</body>

</html>